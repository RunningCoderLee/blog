# æ·±å…¥ç†è§£ Javascript ä¸­çš„ this

## this æ˜¯ä»€ä¹ˆ

`this` åœ¨ `javascript` è¯­è¨€ä¸­æ˜¯ä¸€ä¸ªå…³é”®å­—ï¼Œå®ƒçš„å€¼æŒ‡å‘å½“å‰æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆexecution contextï¼‰çš„ `thisBinding` çš„å€¼ã€‚

æ¯ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡éƒ½åŒ…å«äº†è·Ÿè¸ªç›¸å…³ä»£ç çš„æ‰§è¡Œè¿›åº¦æ‰€éœ€çš„æ‰€æœ‰çŠ¶æ€å’Œä¿¡æ¯ï¼ˆæ¯”å¦‚åœ¨å“ªé‡Œè¢«æ‰§è¡Œï¼Œæ‰§è¡Œæ–¹å¼ï¼Œæ‰§è¡Œå‡½æ•°æ—¶ä¼ å…¥çš„å‚æ•°ç­‰ï¼‰ï¼ŒåŒæ—¶è¿˜åŒ…å« `è¯æ³•çŽ¯å¢ƒï¼ˆLexicalEnvironmentï¼‰` ã€ `å˜é‡çŽ¯å¢ƒï¼ˆVariableEnvironmentï¼‰` ã€ `ThisBinding` è¿™3ä¸ªçŠ¶æ€ç»„ä»¶ ï¼Œå…¶ä¸­ `ThisBinding` çš„å€¼å–å†³äºŽå‡½æ•°è°ƒç”¨æ—¶çš„å„ç§æ¡ä»¶ã€‚

ç»¼ä¸Šï¼Œç®€å•æ¦‚æ‹¬ `this` ç›¸å½“äºŽæ‰§è¡Œä¸Šä¸‹æ–‡çš„ä¸€ä¸ªå±žæ€§ï¼Œç”¨æ¥æŒ‡ä»£æŸä¸ªå¯¹è±¡ä»¥ä¾¿äºŽæˆ‘ä»¬å¯ä»¥ç®€å•çš„è¿›è¡Œå¤ç”¨ã€‚ä½†å…·ä½“æŒ‡ä»£ä»€ä¹ˆå¯¹è±¡åˆ™ç”±æ‰§è¡Œä¸Šä¸‹æ–‡æ‰€å†³å®šã€‚

## this çš„æŒ‡å‘

é¦–å…ˆå¼ºè°ƒ 2 ä¸ªå®¹æ˜“äº§ç”Ÿçš„è¯¯è§£ï¼š

1. ä¸æ˜¯æ’å®šçš„æŒ‡å‘è‡ªèº«
2. ä¸æ˜¯åœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½æŒ‡å‘æ‰€åœ¨å‡½æ•°çš„ä½œç”¨åŸŸ

åœ¨ `javascript` ä¸­ `this` å¹¶ä¸æ˜¯åœ¨ä»£ç ç¼–å†™æ—¶ï¼ˆES6 ä¸­çš„ç®­å¤´å‡½æ•°é™¤å¤–ï¼‰å°±ç¡®å®šå…·ä½“å€¼çš„ï¼Œè€Œæ˜¯å–å†³äºŽå‡½æ•°åœ¨å“ªé‡Œè¢«è°ƒç”¨ã€‚

å‡½æ•°çš„è°ƒç”¨ä½ç½®å¯ä»¥é€šè¿‡åˆ†æžè°ƒç”¨æ ˆæ¥å¾—åˆ°ï¼Œå³å½“å‰æ­£åœ¨æ‰§è¡Œçš„å‡½æ•°çš„å‰ä¸€ä¸ªè°ƒç”¨

```js
function baz() {
  console.log('baz')
  
  bar()
}

function bar() {
  console.log('bar')
  
  foo()
}

function foo() {
  console.log('foo')
}

baz()
```

åˆ†æžä¸€ä¸‹ä¸Šé¢çš„ä»£ç ï¼Œé¦–å…ˆæˆ‘ä»¬åœ¨å…¨å±€çŽ¯å¢ƒä¸‹è°ƒç”¨äº† `baz` è¿™ä¸ªå‡½æ•°ï¼Œæ­¤æ—¶è°ƒç”¨ä½ç½®æ˜¯å…¨å±€ä½œç”¨åŸŸï¼Œå½“å‰è°ƒç”¨æ ˆæ˜¯ `baz` ï¼ŒæŽ¥ç€åœ¨ `baz` ä¸­è°ƒç”¨ `bar` ï¼Œæ­¤æ—¶è°ƒç”¨æ ˆæ˜¯ `baz` -> `bar` ï¼Œè°ƒç”¨ä½ç½®æ˜¯ `baz` ï¼Œæœ€åŽåœ¨ `bar` ä¸­è°ƒç”¨ `foo` ï¼Œæ­¤æ—¶è°ƒç”¨æ ˆæ˜¯ `baz`  -> `bar`  -> `foo` ï¼Œè°ƒç”¨ä½ç½®æ˜¯ `bar`

![alt](./call-site.png)

## ç»‘å®šè§„åˆ™

### é»˜è®¤ç»‘å®š

ç‹¬ç«‹å‡½æ•°è°ƒç”¨ï¼Œåœ¨å…¶ä»–ç»‘å®šè§„åˆ™æ— æ³•åº”ç”¨æ—¶ç”Ÿæ•ˆ

```js
function foo() {
  console.log(this.a)
}

var a = 1

foo() // 1
```

ä¸Šé¢çš„ `foo` å‡½æ•°åœ¨è°ƒç”¨æ—¶æ²¡æœ‰ç»è¿‡ä»»ä½•ä¿®é¥°ï¼Œç›´æŽ¥åœ¨å…¨å±€ä½œç”¨åŸŸä¸‹è¢«è°ƒç”¨ï¼Œå› æ­¤åº”ç”¨é»˜è®¤ç»‘å®šè§„åˆ™ï¼Œæ­¤æ—¶ `foo` ä¸­çš„ `this` æŒ‡å‘å…¨å±€å¯¹è±¡ã€‚ `var a = 1` è¯­å¥ç›¸å½“äºŽç»™å…¨å±€å¯¹è±¡çš„ `a` å±žæ€§èµ‹å€¼ `1`ï¼Œå› æ­¤ `foo` ä¸­æ‰“å°å‡ºçš„ç»“æžœæ˜¯ `1`ã€‚

**ä¾‹å¤–ï¼š**

å¦‚æžœåœ¨ `foo` å‡½æ•°å†…ä½¿ç”¨äº†ä¸¥æ ¼æ¨¡å¼ï¼Œåˆ™ä¸èƒ½å°†å…¨å±€å¯¹è±¡ç”¨äºŽé»˜è®¤ç»‘å®šã€‚

```js
function foo() {
  'use strict'
  
  console.log(this.a)
}

var a = 1

foo() // this is undefined
```

å€¼å¾—ä¸€æçš„æ˜¯ï¼Œé»˜è®¤ç»‘å®šèƒ½å¦ç»‘å®šåˆ°å…¨å±€å¯¹è±¡åªå–å†³äºŽ `foo` å†…éƒ¨æ˜¯å¦è¿è¡Œåœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œè€Œ `foo` æ˜¯å¦æ˜¯åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹è¢«è°ƒç”¨åˆ™ä¸ä¼šå¯¹ç»‘å®šåˆ°å…¨å±€å¯¹è±¡äº§ç”Ÿå½±å“ã€‚

```js
function foo() {
  console.log(this.a)
}

var a = 1

(function() {
  'use strict'
  
  foo() // 1
})()
```

**æ³¨æ„ï¼š** ç‹¬ç«‹è°ƒç”¨ä¸Žå‡½æ•°æ‰€å¤„çš„ä½ç½®æ— å…³ï¼Œæ¯”å¦‚ï¼š

```js
function foo() {
  var a = 2
  
  function bar() {
    console.log(this.a)
  }
  
  bar()
}

var a = 1

foo() // 1
```

### éšå¼ç»‘å®š

å‡½æ•°è¢«è°ƒç”¨æ—¶å¦‚æžœå­˜åœ¨ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œéšå¼ç»‘å®šè§„åˆ™ä¼šå°†å‡½æ•°ä¸­çš„ `this` ç»‘å®šåˆ°è¿™ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡ä¸Šã€‚

```js
function foo() {
  console.log(this.a)
}

var obj = {
  a: 1,
  bar: foo
}

obj.bar() // 1
```

ä¸Šé¢çš„ä»£ç é‡Œï¼Œå‡½æ•° `foo` å®žé™…ä¸Šæ˜¯é€šè¿‡å¯¹è±¡ `obj` çš„ `bar` å±žæ€§å¼•ç”¨åŽè°ƒç”¨çš„ï¼Œæ­¤æ—¶å­˜åœ¨ä¸Šä¸‹æ–‡å¯¹è±¡ `obj` ï¼Œ `foo` å‡½æ•°é‡Œçš„ `this` æ­¤æ—¶è¢«éšå¼ç»‘å®šåœ¨å¯¹è±¡ `obj` ä¸Šï¼Œæ‰€ä»¥æŽ§åˆ¶å°è¾“å‡ºçš„ `this.a` ç›¸å½“äºŽ `obj.a` ï¼Œå³ä¸º `1`ã€‚

å†çœ‹ä¸€ä¸ªç¨å¾®å¤æ‚ä¸€ç‚¹çš„ ðŸŒ°ï¼š

```js
function foo() {
  console.log(this.a)
}

var obj1 = {
  a: 1,
  bar: foo
}

var obj2 = {
  a; 2,
  obj1: obj1
}

obj2.obj1.bar() // 1
```

è¿™æ®µä»£ç é‡Œï¼Œæœ€ç»ˆå‡½æ•° `foo` è¿˜æ˜¯é€šè¿‡ `obj1` çš„å¯¹è±¡ `bar` æ¥è°ƒç”¨çš„ï¼Œå› æ­¤æœ€ç»ˆè¾“å…¥çš„ç»“æžœæ˜¯ `1`ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯å¯¹è±¡å±žæ€§å¼•ç”¨é“¾ä¸Šåªæœ‰æœ€åŽä¸€å±‚åœ¨è°ƒç”¨ä½ç½®ä¸­èµ·ä½œç”¨ã€‚

#### éšå¼ä¸¢å¤±

åœ¨éšå¼ç»‘å®šè§„åˆ™ä¸­æœ‰ä¸€ä¸ªè¾ƒä¸ºå¸¸è§çš„é—®é¢˜æ˜¯éšå¼ä¸¢å¤±ï¼Œå³éšå¼ç»‘å®šçš„å‡½æ•°åº”ç”¨äº†é»˜è®¤ç»‘å®šè§„åˆ™ï¼Œä»Žè€Œå¯¼è‡´ä¸¢å¤±äº†åŽŸæœ¬è¢«ç»‘å®šçš„å¯¹è±¡ã€‚

```js
function foo() {
  console.log(this.a)
}

var obj = {
  a: 1,
  bar: foo
}

var baz = obj.bar

var a = 2

baz() // 2
```

è™½ç„¶ä»Žä»£ç ä¸Šçœ‹å˜é‡ `baz` æ˜¯å¯¹ `obj.bar` çš„å¼•ç”¨ï¼Œä½†å®žé™…ä¸Š `baz` å’Œ `obj.bar` éƒ½æ˜¯å¯¹å‡½æ•° `foo` çš„ç›´æŽ¥å¼•ç”¨ï¼Œå› æ­¤ `baz` å®žé™…ä¸Šå°±æ˜¯ä¸å¸¦ä»»ä½•ä¿®é¥°çš„å‡½æ•° `foo` è°ƒç”¨ï¼Œæ‰€ä»¥åº”ç”¨äº†é»˜è®¤ç»‘å®šã€‚

è¿˜æœ‰ä¸€ç§æ¯”è¾ƒå¸¸è§çš„æƒ…å†µæ˜¯å›žè°ƒå‡½æ•°ï¼Œæ¯”å¦‚ï¼š

```js
function foo() {
  console.log(this.a)
}

var obj = {
  a: 1,
  bar: foo
}

var a = 2

setTimeout(obj.bar, 1000) // 2
```

ä¸Šé¢çš„å›žè°ƒå‡½æ•°ä¹Ÿä¼šå‡ºçŽ°éšå¼ç»‘å®šä¸¢å¤±çš„é—®é¢˜ï¼Œæ ¹æœ¬åŽŸå› æ˜¯æŠŠå‡½æ•°å½“ä½œå‚æ•°ä¼ é€’ç»™å¦ä¸€ä¸ªå‡½æ•°æ—¶æœ¬è´¨ä¸Šå…¶å®žå°±æ˜¯ä¸€ç§éšå¼èµ‹å€¼ï¼Œç±»ä¼¼äºŽå‰ä¸€ä¸ªä¾‹å­ä¸­çš„ `var baz = obj.bar`ï¼Œå› æ­¤ç»“æžœå’Œä¸Šä¸€ä¸ªä¾‹å­ä¸€è‡´ã€‚

### æ˜¾å¼ç»‘å®š

åœ¨ `JavaScript` çš„å®¿ä¸»çŽ¯å¢ƒä¸­ä¼šæœ‰ä¸€ä¸ª `Function.prototype` å¯¹è±¡ï¼Œæ‰€æœ‰åŽŸåž‹é“¾ä¸Šå­˜åœ¨è¯¥å¯¹è±¡çš„å‡½æ•°éƒ½å¯ä»¥è°ƒç”¨ `.call`ã€`.apply` å’Œ `.bind` è¿™ 3 ä¸ªæ–¹æ³•ï¼Œé€šè¿‡è¿™3ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥æ˜¾å¼çš„å°†æˆ‘ä»¬å¸Œæœ›ç»‘å®šçš„å†…å®¹é€šè¿‡å‚æ•°çš„å½¢å¼ä¼ é€’å’Œç»‘å®šç»™æ¨¡æ¿å‡½æ•°çš„ `this`

```js
function foo() {
  console.log(this.a)
}

var obj = {
  a: 1
}

var a = 2

foo.call(obj) // 1
foo.apply(obj) // 1
foo.bind(obj)() // 1
```

#### call å’Œ apply

ä»Ž `this` ç»‘å®šçš„è§’åº¦æ¥è¯´, `call` å’Œ `apply` æ˜¯ä¸€æ ·çš„æ•ˆæžœï¼Œåªæ˜¯ä»–ä»¬çš„å‚æ•°æœ‰ä¸€äº›åŒºåˆ«ï¼Œç¬¬ä¸€ä¸ªå‚æ•°çš„ä½œç”¨éƒ½æ˜¯ç”¨æ¥æ”¹å˜ä¸Šä¸‹æ–‡å¯¹è±¡çš„ï¼Œä¸åŒçš„æ˜¯ä»Žç¬¬äºŒä¸ªå‚æ•°å¼€å§‹ï¼Œå¦‚æžœç›®æ ‡å‡½æ•°æŽ¥æ”¶å¤šä¸ªå‚æ•°ï¼Œé€šè¿‡ `call` æ–¹æ³•éœ€è¦åŒæ ·ä»¥å¤šä¸ªå‚æ•°çš„å½¢å¼è¿›è¡Œä¼ é€’ï¼Œè€Œä½¿ç”¨ `apply` æ–¹æ³•åˆ™å¯ä»¥é€šè¿‡ä¼ é€’ä¸€ä¸ªæ•°ç»„å½¢å¼çš„å€¼æ¥å°†æ•°ç»„ä¸­çš„å€¼åˆ†å‘åˆ°ç›®æ ‡å‡½æ•°çš„å„ä¸ªå‚æ•°ã€‚

ä¸¾ä¸ª ðŸŒ°ï¼š

```js
// æ±‚ä¸€ä¸ªæ•°ç»„å†…çš„æœ€å¤§å€¼

var arr = [5, 1, 30, 2, 14]

Math.max.call(null, 5, 1, 30, 2, 14) // 30
Math.max.call(null, ...arr) // 30
Math.max.call(null, arr) // NaN
Math.max.apply(null, arr) // 30
```

#### bind

`call` å’Œ `apply` è™½ç„¶å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ˜¾ç¤ºçš„æŒ‡å®š `this` çš„å…·ä½“æŒ‡å‘ï¼Œä½†æ˜¯ä¾ç„¶æ²¡æ³•è§£å†³æˆ‘ä»¬å‰é¢æå‡ºçš„éšå¼ä¸¢å¤±çš„é—®é¢˜ï¼Œé™¤éžæˆ‘ä»¬åœ¨è°ƒç”¨ `baz` çš„æ—¶å€™é€šè¿‡ `baz.call(obj)` è¿™æ ·çš„å½¢å¼ã€‚å¦‚æžœæˆ‘ä»¬æƒ³é€šè¿‡ `baz()` è¿™æ ·ç®€å•çš„çš„è°ƒç”¨å½¢å¼æ¥å®žçŽ° `this` ç»‘å®šçš„å˜æ¢ï¼Œå°±éœ€è¦ç”¨åˆ° `.bind` è¿™ä¸ªæ–¹æ³•äº†ã€‚

```js
function foo() {
  console.log(this.a)
}

var obj = {
  a: 1,
  bar: foo
}

var a = 2

var baz = foo.bind(obj)
baz() // 1

var bat = obj.bar.bind(obj)
bat() // 1
```

**æ³¨æ„ï¼š** å¦‚æžœåœ¨ä½¿ç”¨ `call/bind/apply` æ—¶ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯éžç©ºçš„åŸºæœ¬æ•°æ®ç±»åž‹ï¼ˆå­—ç¬¦ä¸²ï¼Œæ•°å­—ï¼Œå¸ƒå°”ï¼‰ï¼Œé‚£ä¹ˆæœ€ç»ˆ `this` ç»‘å®šçš„å€¼ä¼šæŒ‡å‘è¿™äº›åŸºæœ¬æ•°æ®çš„å¯¹è±¡å½¢å¼ï¼ˆå¦‚`String('123')`ï¼Œ`Number(123)`ï¼Œ`Boolean(false)`ï¼‰ã€‚

### new ç»‘å®š

åœ¨ `JavaScript` ä¸­ä½¿ç”¨ `new` å…³é”®å­—æ‰§è¡Œå‡½æ•°æ—¶ä¹Ÿä¼šå‘ç”Ÿ `this` æŒ‡å‘çš„å˜æ›´ï¼Œåœ¨æ˜Žç¡® `this` æŒ‡å‘å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ä½¿ç”¨ `new` è°ƒç”¨å‡½æ•°çš„æ—¶å€™ä¼šæ‰§è¡Œå“ªäº›æ“ä½œ

1. åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„å¯¹è±¡
2. ç»™æ–°å¯¹è±¡çš„å†…éƒ¨å±žæ€§ `[[prototype]]` èµ‹å€¼
3. å°†æ–°å¯¹è±¡ç»‘å®šåˆ°å‡½æ•°è°ƒç”¨çš„ `this`
4. å¦‚æžœå‡½æ•°æ²¡æœ‰è¿”å›žå…¶ä»–å¯¹è±¡ï¼Œåˆ™è‡ªåŠ¨è¿”å›žæ–°åˆ›å»ºçš„è¿™ä¸ªå¯¹è±¡

```js
function foo(a) {
  this.a = a
}

var bar = new foo(1)
console.log(bar.a) // 1
```

ä¸Šé¢çš„ä»£ç ä¸­æˆ‘ä»¬ç”¨ `new` æ¥è°ƒç”¨å‡½æ•° `foo`  æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡å¹¶ä¸”ç»‘å®šåˆ° `this` ä¸Šï¼Œå› ä¸º `foo` å†…éƒ¨æ²¡æœ‰è¿”å›žä»»ä½•å†…å®¹ï¼Œå› æ­¤æœ€ç»ˆè¿”å›žäº†è¿™ä¸ªæ–°åˆ›å»ºçš„å¯¹è±¡ã€‚

å¦‚æžœè¢«è°ƒç”¨çš„å‡½æ•°å†…éƒ¨æœ‰æ˜¾ç¤ºè¿”å›žå¯¹è±¡ç±»åž‹ï¼Œåˆ™ä¼šç›´æŽ¥è¿”å›žè¿™ä¸ªå¯¹è±¡ï¼Œå¦‚æžœæ˜¾ç¤ºè¿”å›žçš„å€¼æ˜¯åŸºæœ¬ç±»åž‹ï¼Œåˆ™è¿”å›žæœ€åˆåˆ›å»ºçš„å¯¹è±¡

```js
function foo1(a) {
  this.a = a

  return {
    a: 2
  }
}

var bar1 = new foo1(1)
console.log(bar1.a) // 2

function foo2(a) {
  this.a = a

  return 'hello world'
}

var bar2 = new foo2(1)
console.log(bar2.a) // 1
```

### ç®­å¤´å‡½æ•°ä¸­çš„ç»‘å®š

ç®­å¤´å‡½æ•°ä¸­çš„ `this` ç»‘å®šä¸éµä»Žä¸Šè¿°ä»»ä¸€åŽŸåˆ™ï¼Œè€Œæ˜¯æ ¹æ®å¤–å±‚å‡½æ•°ä½œç”¨åŸŸæˆ–å…¨å±€ä½œç”¨åŸŸæ¥å†³å®šçš„ã€‚

```js
function foo() {
  return () => {
    console.log(this.a)
  }
}

var obj1 = {
  a: 1
}

var obj2 = {
  a; 2
}

var bar = foo.call(obj1)
bar.call(obj2) // 1
```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œ`foo` å†…éƒ¨çš„ç®­å¤´å‡½æ•°ä¼šæ•èŽ· `foo` è¢«è°ƒç”¨æ—¶å…¶å†…éƒ¨çš„ `this` çš„å€¼ï¼Œå³å˜é‡ `bar` æ‰€å¼•ç”¨çš„ç®­å¤´å‡½æ•°ä¸­çš„ `this` ä¼šè¢«ç»‘å®šåˆ°è°ƒç”¨ `foo` å‡½æ•°æ—¶ï¼Œ`foo` å†…éƒ¨çš„ `this` å€¼ `obj1`ã€‚

ä¸Šé¢çš„ä»£ç çº¦ç­‰äºŽï¼š

```js
function foo() {
  var self = this

  return function() {
    console.log(self.a)
  }
}

var obj1 = {
  a: 1
}

var obj2 = {
  a: 2
}

var bar = foo.call(obj1)
bar.call(obj2) // 1
```

**æ³¨æ„ï¼š** ç®­å¤´å‡½æ•°ç»‘å®šçš„ `this` æ— æ³•è¢«ä¿®æ”¹ï¼Œå³ä½¿æ˜¯ `new` ä¹Ÿä¸è¡Œã€‚

## this ç»‘å®šæ›´æ”¹çš„ä¼˜å…ˆçº§

### `ç®­å¤´å‡½æ•°` VS `å…¶ä»–`

å…ˆæ¥çœ‹ä¸‹åœ¨æµè§ˆå™¨çŽ¯å¢ƒä¸­æ‰§è¡Œä¸‹é¢ä»£ç åŽçš„ç»“æžœ

```js
var foo = () => {
  console.log(this)
}

var obj = {
  bar: foo
}

foo() // Window
obj.bar() // Window
foo.call(obj) // Window
foo.apply(obj) // Window
foo.bind(obj)() // Window
var bar = new foo() // TypeError: foo is not a constructor
```

ä»Žä¸Šé¢çš„æµ‹è¯•ç»“æžœå¯ä»¥çœ‹åˆ°ï¼Œç®­å¤´å‡½æ•°çš„ `this` ç»‘å®šè§„åˆ™ä¼˜å…ˆçº§æœ€é«˜ã€‚

### `new ç»‘å®š` VS `æ˜¾ç¤ºç»‘å®š`

ç”±äºŽ `call` å’Œ `apply` éƒ½ä¸èƒ½è¢«å½“ä½œæž„é€ å‡½æ•°ä½¿ç”¨ï¼ˆè§„èŒƒé™å®šï¼‰ï¼Œå› æ­¤æ— æ³•ç›´æŽ¥é€šè¿‡ `new foo.call(obj1)` è¿™æ ·çš„å½¢å¼æ¥ç›´æŽ¥æµ‹è¯•ï¼Œä½†æ˜¯ `bind` å‡½æ•°ä¼šè¿”å›žä¸€ä¸ªå·²ç»è¢«æ›´æ”¹ç»‘å®š `this` åˆ°æŒ‡å®šå€¼çš„å‡½æ•°ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡å¯¹æ¯” `new` å’Œè¢« `bind` ä¹‹åŽçš„å‡½æ•°æ¥è¿›è¡ŒéªŒè¯ã€‚

```js
function foo(value) {
  this.a = value
}

var obj1 = {}

var bar = foo.bind(obj1)
bar(1)
console.log(obj1.a) // 1

var baz = new bar(2)
console.log(baz.a) // 2
console.log(obj1.a) // 1
```

ä»Žä¸Šé¢çš„ä¾‹å­ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåœ¨å¯¹è¢« `bind` æ›´æ”¹è¿‡ `this` æŒ‡å‘çš„å‡½æ•°è¿›è¡Œ `new` è°ƒç”¨åŽï¼Œ`this` çš„æŒ‡å‘å†æ¬¡å‘ç”Ÿäº†æ›´æ”¹ï¼Œå› æ­¤ `newç»‘å®š` çš„ä¼˜å…ˆçº§è¦é«˜äºŽ `æ˜¾ç¤ºç»‘å®š`ã€‚

### `bind` VS `call/apply`

åœ¨æ˜¾ç¤ºç»‘å®šä¸­æˆ‘ä»¬å¯ä»¥é€šè¿‡ `bind`ï¼Œ`call`ï¼Œ`apply` å¯¹å‡½æ•°ä¸­çš„ `this` æŒ‡å‘è¿›è¡Œå˜æ›´ï¼Œé‚£ä¹ˆä»–ä»¬ä¹‹é—´çš„ä¼˜å…ˆçº§æ˜¯å¦ç›¸åŒå‘¢

```js
function foo() {
  console.log(this.a)
}

var a = 0

var obj1 = {
  a: 1,
  bar: foo
}

var obj2 = {
  a: 2
}

foo.call(obj1) // 1

var baz = foo.bind(obj2)
baz.call(obj1) // 2
baz.apply(obj1) // 2

var tmp = baz.bind(obj1)
tmp() // 2
```

ä¸Šé¢çš„ä¾‹å­å¯ä»¥çœ‹åˆ°ï¼Œè¢« `bind` æ›´æ”¹è¿‡ `this` æŒ‡å‘çš„å‡½æ•° `baz`ï¼Œå†æ¬¡è°ƒç”¨ `call/apply/bind` è¿›è¡Œæ›´æ”¹ `this` çš„è¡Œä¸ºéƒ½ä¼šå¤±æ•ˆï¼Œå› æ­¤ `bind` çš„ä¼˜å…ˆçº§è¦é«˜äºŽ `call/apply`

### `æ˜¾å¼ç»‘å®š` VS `éšç¤ºç»‘å®š`

```js
function foo() {
  console.log(this.a)
}

var obj1 = {
  a: 1,
  bar: foo
}

var obj2 = {
  a: 2,
  bar: foo
}

obj1.bar() // 1
obj2.bar() // 2

obj1.bar.call(obj2) // 2
obj2.bar.call(obj1) // 1

var baz = obj1.bar.bind(obj2)
baz() // 2
```

ä»Žä¸Šé¢çš„ä¾‹å­å¯ä»¥çœ‹åˆ° `æ˜¾ç¤ºç»‘å®š` çš„è§„åˆ™ä¼˜å…ˆçº§æ˜¯è¦é«˜äºŽ `éšå¼ç»‘å®š` è§„åˆ™çš„ã€‚

**æ³¨æ„ï¼š** æˆ‘ä»¬åœ¨ä½¿ç”¨ `call/apply/bind` å‡½æ•°çš„æ—¶å€™æ˜¯å¯ä»¥**ä¸ç»™**ç¬¬ä¸€ä¸ªå‚æ•°ä¼ å€¼æˆ–è€…æ˜¯ä¼  `null` çš„ï¼Œå‘ç”Ÿè¿™ç§æƒ…å†µæ—¶ `this` æŒ‡å‘åˆä¼šå‘ç”Ÿä»€ä¹ˆå˜åŒ–å‘¢ï¼Ÿ

```js
function foo() {
  console.log(this.a)
}

var a = 0

var obj1 = {
  a: 1,
  bar: foo
}

var obj2 = {
  a: 2
}


foo() // 0
foo.call() // 0
foo.apply() // 0
foo.bind()() // 0
foo.call(null) // 0
foo.apply(null) // 0
foo.bind(null)() // 0

obj1.bar() // 1
obj1.bar.call() // 0
obj1.bar.apply() // 0
obj1.bar.bind()() // 0
obj1.bar.call(null) // 0
obj1.bar.apply(null) // 0
obj1.bar.bind(null)() // 0
```

æ ¹æ®ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹åˆ°å¦‚æžœæˆ‘ä»¬åœ¨è°ƒç”¨ `call/apply/bind` æ—¶ä¸ä¼ ç¬¬ä¸€ä¸ªå‚æ•°æˆ–è€…ç¬¬ä¸€ä¸ªå‚æ•°çš„å€¼æ˜¯ `null` æ—¶ï¼Œæ­¤æ—¶çš„ `this` éƒ½ä¼šåº”ç”¨ `é»˜è®¤ç»‘å®š` è§„åˆ™ã€‚

### æ€»ç»“

ç»“åˆä¸Šé¢å„ç§æƒ…å†µçš„å‘ˆçŽ°ï¼Œæˆ‘ä»¬å¯ä»¥æ¥æ€»ç»“ä¸€ä¸‹åˆ¤æ–­ `this` çš„é¡ºåºï¼š

1. å‡½æ•°æ˜¯å¦æ˜¯ç®­å¤´å‡½æ•°ï¼Ÿå¦‚æžœæ˜¯çš„è¯ï¼Œé‚£ä¹ˆ `this` ç»‘å®šçš„å€¼å–å†³äºŽç®­å¤´å‡½æ•°å¤–éƒ¨å‡½æ•°ä½œç”¨åŸŸæˆ–è€…å…¨å±€ä½œç”¨åŸŸã€‚
2. å‡½æ•°æ˜¯å¦è¢«å½“ä½œæž„é€ å‡½æ•°åœ¨ `new` ä¸­è¢«è°ƒç”¨ï¼Ÿå¦‚æžœæ˜¯ï¼Œé‚£ä¹ˆ `this` ç»‘å®šçš„æ˜¯é€šè¿‡ `new` å†…éƒ¨è¡Œä¸ºæ–°åˆ›å»ºçš„å¯¹è±¡ã€‚
3. å‡½æ•°æ˜¯å¦é€šè¿‡ `bind` è¿›è¡Œè¿‡ `this` ç»‘å®šä¸”ä¼ å…¥çš„ `this` å‚æ•°ä¸ä¸º `undefined` æˆ– `null` ï¼Ÿå¦‚æžœæ˜¯ï¼Œé‚£ä¹ˆ `this` ç»‘å®šçš„å€¼æ˜¯è°ƒç”¨ `bind` æ—¶ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°å€¼ã€‚
4. å‡½æ•°æ˜¯å¦é€šè¿‡ `call/apply` è¿›è¡Œè°ƒç”¨ä¸”ä¼ å…¥çš„ `this` å‚æ•°ä¸ä¸º `undefined` æˆ– `null`ï¼Ÿå¦‚æžœæ˜¯ï¼Œé‚£ä¹ˆ `this` ç»‘å®šçš„å€¼æ˜¯è°ƒç”¨ `call/apply` æ—¶ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°å€¼ã€‚
5. å‡½æ•°æ˜¯å¦åœ¨æŸä¸ªä¸Šä¸‹æ–‡å¯¹è±¡ä¸­è°ƒç”¨ï¼Ÿå¦‚æžœæ˜¯ï¼Œé‚£ä¹ˆ `this` ç»‘å®šçš„æ˜¯è¿™ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡ã€‚
6. å¦‚æžœéƒ½ä¸æ˜¯ï¼Œä½¿ç”¨é»˜è®¤ç»‘å®šï¼Œå‡½æ•°ä½“å†…å¦‚æžœæ˜¯ä¸¥æ ¼æ¨¡å¼ï¼Œ`this` ç»‘å®šçš„æ˜¯ `undefined`ï¼Œå¦‚æžœæ˜¯éžä¸¥æ ¼æ¨¡å¼ï¼Œ`this` ç»‘å®šçš„æ˜¯å…¨å±€å¯¹è±¡ã€‚

æœ€åŽç”¨ä¸€äº›æµ‹è¯•ç”¨ä¾‹æ¥ä½è¯ä¸Šé¢çš„ç»“è®º

```js
var a = 0

var foo1 = () => {
  console.log(this)
}

var obj1 = {
  name: 'obj1',
  foo: foo1
}

foo1() // å…¨å±€å¯¹è±¡
foo1.bind(obj1)() // å…¨å±€å¯¹è±¡
foo1.call(obj1) // å…¨å±€å¯¹è±¡
foo1.apply(obj1) // å…¨å±€å¯¹è±¡
obj1.foo() //
// var foo1 = new foo() // TypeError, foo is not a constructor

function foo2(value) {
  this.a = value
}

var obj2 = {
  a: 2,
  foo: foo2
}
var obj3 = {
  a: 3
}

const tmp1 = new foo2(1)
console.log(tmp1.a) // 1
const tmp2 = new obj2.foo(1)
console.log(tmp2.a) // 1
const tmp3 = new (foo2.bind(obj3))(3)
console.log(tmp3.a) // 3

function foo3() {
  console.log(this)
}

var obj4 = {
  a: 4,
  foo: foo3
}

var foo4 = foo3.bind(obj4)

var obj5 = {
  foo: foo4
}


foo4() // obj4
foo4.call(obj3) // obj4
foo4.apply(obj3) // obj4
obj5.foo.call(obj3) // obj4
obj5.foo.apply(obj3) // obj4
obj5.foo.bind(obj3)() // obj4

var obj6 = {
  a: 6,
  foo: foo3
}

foo3.call(obj6) // obj6
foo3.apply(obj6) // obj6
obj6.foo.call(obj3) // obj3
obj6.foo.apply(obj3) // obj3
obj6.foo.bind(obj3)() // obj3

foo3() // å…¨å±€å¯¹è±¡
foo3.call() // å…¨å±€å¯¹è±¡
foo3.apply() // å…¨å±€å¯¹è±¡
foo3.call(null) // å…¨å±€å¯¹è±¡
foo3.apply(null) // å…¨å±€å¯¹è±¡
foo3.bind(null)() // å…¨å±€å¯¹è±¡

var foo6 = obj6.foo
foo6() // å…¨å±€å¯¹è±¡
```

ï¼ˆå®Œï¼‰

## å‚è€ƒæ–‡æ¡£

> [You Don't Know JS: this & Object Prototypes](https://github.com/getify/You-Dont-Know-JS/tree/master/this%20%26%20object%20prototypes)